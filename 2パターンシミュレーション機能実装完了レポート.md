# 2パターンシミュレーション機能実装完了レポート

## 実装日時
2026年1月3日

## 実装概要
不動産管理アプリのシミュレーション機能を「物件ベースシミュレーション」と「独立シミュレーション」の2パターンに分けて実装しました。

---

## 実装内容

### 1. シミュレーション種別の追加

#### パターン1: 物件ベースシミュレーション
- **概要**: 既存の物件データに基づいて自動計算
- **特徴**:
  - 登録済みの物件データから家賃収入を自動取得
  - 物件の取得価額、耐用年数から減価償却費を自動計算
  - 特定物件または全物件の合算でシミュレーション可能
- **用途**: 実際の物件の収支予測

#### パターン2: 独立シミュレーション
- **概要**: 物件データに依存せず、すべて手動入力
- **特徴**:
  - 年間家賃収入を手動入力
  - 部屋数などの参考情報も入力可能
  - 物件データがなくてもシミュレーション可能
- **用途**: 仮想的なシナリオ分析、購入検討中の物件の試算

---

## 技術実装

### 1. データベースモデル（`app/models_property.py`）

```python
class TSimulation(Base):
    # シミュレーション種別
    シミュレーション種別 = Column(String(20), nullable=False, server_default='物件ベース')
    
    # 物件ベースシミュレーション用
    物件id = Column(Integer, ForeignKey('T_物件.id'), nullable=True)
    
    # 独立シミュレーション用
    年間家賃収入 = Column(Numeric(15, 2), nullable=True)
    部屋数 = Column(Integer, nullable=True)
```

**追加フィールド**:
- `シミュレーション種別`: "物件ベース" または "独立"
- `年間家賃収入`: 独立シミュレーション用の手動入力値
- `部屋数`: 独立シミュレーション用の参考情報

### 2. 計算ロジック（`app/blueprints/property.py`）

**`calculate_simulation`関数の修正**:

```python
def calculate_simulation(simulation, db):
    # シミュレーション種別による分岐
    if simulation.シミュレーション種別 == '独立':
        # 独立シミュレーション: 手動入力値を使用
        total_rent = simulation.年間家賃収入 or Decimal('0')
    else:
        # 物件ベースシミュレーション: 物件データから取得
        if simulation.物件id:
            # 特定物件の家賃収入を計算
            ...
        else:
            # 全物件の家賃収入を合算
            ...
```

**主な変更点**:
- シミュレーション種別に応じて家賃収入の取得方法を切り替え
- 独立シミュレーションでは手動入力値を直接使用
- 物件ベースでは既存のロジックを維持

### 3. UI/UX（`app/templates/property_simulation_new.html`）

**シミュレーション種別選択**:
```html
<select class="form-select" id="シミュレーション種別" name="シミュレーション種別" 
        required onchange="toggleSimulationType()">
    <option value="物件ベース">物件ベース（既存物件データを使用）</option>
    <option value="独立">独立シミュレーション（手動入力）</option>
</select>
```

**動的フィールド切り替え**:
- JavaScriptで選択に応じて表示フィールドを切り替え
- 物件ベース: 物件選択ドロップダウンを表示
- 独立: 年間家賃収入と部屋数の入力欄を表示

---

## マイグレーション

### マイグレーションスクリプト
`migrate_add_simulation_type_fields.py`

**追加されるカラム**:
1. `シミュレーション種別` (VARCHAR/TEXT, DEFAULT '物件ベース')
2. `年間家賃収入` (NUMERIC/REAL)
3. `部屋数` (INTEGER)

### マイグレーション実行方法

#### 方法1: ローカルから実行（推奨）
```bash
cd /home/ubuntu/property-management-app
export DATABASE_URL="postgres://..."  # HerokuのDATABASE_URL
source venv/bin/activate
python migrate_add_simulation_type_fields.py
```

#### 方法2: Heroku Dashboardから実行
1. https://dashboard.heroku.com/apps/property-management-app-d46351d49159 にアクセス
2. "More" → "Run console" をクリック
3. `python migrate_add_simulation_type_fields.py` を実行

#### 方法3: Heroku CLIから実行
```bash
heroku run python migrate_add_simulation_type_fields.py -a property-management-app-d46351d49159
```

---

## 使い方

### 物件ベースシミュレーション

1. シミュレーション作成画面で「物件ベース」を選択
2. 対象物件を選択（または「全物件」を選択）
3. 稼働率、経費率、ローン情報などを入力
4. 「シミュレーションを作成」をクリック

**自動計算される項目**:
- 年間家賃収入（物件の部屋の賃料から自動計算）
- 減価償却費（物件の取得価額、耐用年数から自動計算、手動入力も可能）

### 独立シミュレーション

1. シミュレーション作成画面で「独立シミュレーション」を選択
2. **年間家賃収入**を手動入力（必須）
3. 部屋数を入力（任意）
4. 稼働率、経費率、ローン情報などを入力
5. 減価償却費を手動入力（必須）
6. 「シミュレーションを作成」をクリック

**すべて手動入力**:
- 年間家賃収入
- 減価償却費
- その他すべての経費項目

---

## 動作確認

### 実装済み
✅ データベースモデルの修正  
✅ 計算ロジックの実装  
✅ UIテンプレートの実装  
✅ GitHubへのプッシュ  
✅ Herokuへのデプロイ

### 未完了（要手動実行）
⚠️ データベースマイグレーション

**理由**: ローカル環境からHerokuのPostgreSQLへの接続が不安定なため、マイグレーションスクリプトが途中で停止しました。

**対応**: 上記の「マイグレーション実行方法」のいずれかの方法で手動実行してください。

---

## 今後の拡張案

### 1. シミュレーション比較機能
複数のシミュレーションを並べて比較できる機能

### 2. グラフの追加
- 物件別収支比較グラフ
- シナリオ別比較グラフ

### 3. エクスポート機能
- PDF出力
- Excel出力

### 4. テンプレート機能
よく使うシミュレーション設定をテンプレートとして保存

---

## まとめ

不動産管理アプリのシミュレーション機能を2パターンに拡張し、より柔軟なシミュレーションが可能になりました。

- **物件ベース**: 実際の物件データに基づく正確な収支予測
- **独立**: 仮想的なシナリオ分析や購入検討中の物件の試算

マイグレーションを実行すれば、すぐに本番環境で利用可能です。

---

## 関連ファイル

- モデル: `app/models_property.py`
- ロジック: `app/blueprints/property.py`
- テンプレート: `app/templates/property_simulation_new.html`
- マイグレーション: `migrate_add_simulation_type_fields.py`
- 設計ドキュメント: `docs/SIMULATION_TWO_PATTERNS_DESIGN.md`
