# 減価償却費自動計算機能の仕様書

**作成日**: 2026年1月3日  
**対象**: シミュレーション機能（物件ベース・独立シミュレーション両方）

---

## 📋 要件

### ユーザー要望

1. **独立シミュレーション**の場合、耐用年数を入れたら自動で減価償却費が計算される
2. **建物部分**、**建物付属設備**、**構築物**の3つに分けて、それぞれ耐用年数と償却方法を選べる
3. **物件ベースシミュレーション**も同じように対応する

---

## 🏗️ 設計方針

### 1. データベーススキーマの拡張

T_シミュレーションテーブルに以下のフィールドを追加：

#### 建物部分

| フィールド名 | データ型 | NULL制約 | デフォルト値 | 説明 |
|-------------|----------|----------|--------------|------|
| 建物_取得価額 | NUMERIC(15, 2) | NULL | 0 | 建物部分の取得価額 |
| 建物_耐用年数 | INTEGER | NULL | 47 | 建物部分の耐用年数（RC造の場合47年） |
| 建物_償却方法 | VARCHAR(20) | NULL | '定額法' | 定額法/定率法 |
| 建物_残存価額 | NUMERIC(15, 2) | NULL | 0 | 建物部分の残存価額 |

#### 建物付属設備

| フィールド名 | データ型 | NULL制約 | デフォルト値 | 説明 |
|-------------|----------|----------|--------------|------|
| 付属設備_取得価額 | NUMERIC(15, 2) | NULL | 0 | 建物付属設備の取得価額 |
| 付属設備_耐用年数 | INTEGER | NULL | 15 | 建物付属設備の耐用年数 |
| 付属設備_償却方法 | VARCHAR(20) | NULL | '定額法' | 定額法/定率法 |
| 付属設備_残存価額 | NUMERIC(15, 2) | NULL | 0 | 建物付属設備の残存価額 |

#### 構築物

| フィールド名 | データ型 | NULL制約 | デフォルト値 | 説明 |
|-------------|----------|----------|--------------|------|
| 構築物_取得価額 | NUMERIC(15, 2) | NULL | 0 | 構築物の取得価額 |
| 構築物_耐用年数 | INTEGER | NULL | 20 | 構築物の耐用年数 |
| 構築物_償却方法 | VARCHAR(20) | NULL | '定額法' | 定額法/定率法 |
| 構築物_残存価額 | NUMERIC(15, 2) | NULL | 0 | 構築物の残存価額 |

---

## 📐 減価償却費の計算式

### 定額法

```
年間減価償却費 = (取得価額 - 残存価額) ÷ 耐用年数
```

### 定率法

```
償却率 = 1 ÷ 耐用年数 × 2（200%定率法）
年間減価償却費 = 期首帳簿価額 × 償却率
```

**注**: 定率法の場合、毎年の減価償却費が変動するため、シミュレーション結果テーブルで年度ごとに計算する必要があります。

### 合計減価償却費

```
年間減価償却費合計 = 建物_年間減価償却費 + 付属設備_年間減価償却費 + 構築物_年間減価償却費
```

---

## 🎨 UIの設計

### フォームの構成

#### 基本情報セクション（既存）

- シミュレーション名
- シミュレーション種別
- 対象物件
- 開始年度
- 期間

#### 減価償却設定セクション（新規）

**建物部分**
- 建物_取得価額（円）
- 建物_耐用年数（年）
- 建物_償却方法（ドロップダウン: 定額法/定率法）
- 建物_残存価額（円）
- 建物_年間減価償却費（自動計算、読み取り専用）

**建物付属設備**
- 付属設備_取得価額（円）
- 付属設備_耐用年数（年）
- 付属設備_償却方法（ドロップダウン: 定額法/定率法）
- 付属設備_残存価額（円）
- 付属設備_年間減価償却費（自動計算、読み取り専用）

**構築物**
- 構築物_取得価額（円）
- 構築物_耐用年数（年）
- 構築物_償却方法（ドロップダウン: 定額法/定率法）
- 構築物_残存価額（円）
- 構築物_年間減価償却費（自動計算、読み取り専用）

**合計**
- 年間減価償却費合計（自動計算、読み取り専用）

#### 収入設定セクション（既存）

- 稼働率
- その他収入

#### 経費設定セクション（既存）

- 管理費率
- 修繕費率
- 固定資産税
- 損害保険料
- ~~年間減価償却費~~（削除 → 減価償却設定セクションに移動）
- その他経費

---

## 🔧 実装方針

### 1. モデルの修正

**ファイル**: `app/models_property.py`

```python
class TSimulation(Base):
    # 既存のフィールド
    ...
    
    # 減価償却設定（建物部分）
    建物_取得価額 = Column(Numeric(15, 2), nullable=True, default=0)
    建物_耐用年数 = Column(Integer, nullable=True, default=47)
    建物_償却方法 = Column(String(20), nullable=True, default='定額法')
    建物_残存価額 = Column(Numeric(15, 2), nullable=True, default=0)
    
    # 減価償却設定（建物付属設備）
    付属設備_取得価額 = Column(Numeric(15, 2), nullable=True, default=0)
    付属設備_耐用年数 = Column(Integer, nullable=True, default=15)
    付属設備_償却方法 = Column(String(20), nullable=True, default='定額法')
    付属設備_残存価額 = Column(Numeric(15, 2), nullable=True, default=0)
    
    # 減価償却設定（構築物）
    構築物_取得価額 = Column(Numeric(15, 2), nullable=True, default=0)
    構築物_耐用年数 = Column(Integer, nullable=True, default=20)
    構築物_償却方法 = Column(String(20), nullable=True, default='定額法')
    構築物_残存価額 = Column(Numeric(15, 2), nullable=True, default=0)
```

### 2. フォームの修正

**ファイル**: `app/blueprints/property/views.py`

- 新しいフィールドをフォームに追加
- JavaScriptで自動計算機能を実装
- 取得価額、耐用年数、償却方法、残存価額が変更されたら自動計算

### 3. 計算ロジックの実装

**ファイル**: `app/blueprints/property/simulation_logic.py`（新規作成）

```python
def calculate_depreciation(取得価額, 耐用年数, 償却方法, 残存価額=0):
    """
    減価償却費を計算
    
    Args:
        取得価額: 取得価額（円）
        耐用年数: 耐用年数（年）
        償却方法: '定額法' or '定率法'
        残存価額: 残存価額（円）
    
    Returns:
        年間減価償却費（円）
    """
    if 償却方法 == '定額法':
        return (取得価額 - 残存価額) / 耐用年数
    elif 償却方法 == '定率法':
        償却率 = 1 / 耐用年数 * 2  # 200%定率法
        return 取得価額 * 償却率
    else:
        return 0

def calculate_total_depreciation(simulation):
    """
    合計減価償却費を計算
    
    Args:
        simulation: TSimulationオブジェクト
    
    Returns:
        年間減価償却費合計（円）
    """
    建物 = calculate_depreciation(
        simulation.建物_取得価額,
        simulation.建物_耐用年数,
        simulation.建物_償却方法,
        simulation.建物_残存価額
    )
    
    付属設備 = calculate_depreciation(
        simulation.付属設備_取得価額,
        simulation.付属設備_耐用年数,
        simulation.付属設備_償却方法,
        simulation.付属設備_残存価額
    )
    
    構築物 = calculate_depreciation(
        simulation.構築物_取得価額,
        simulation.構築物_耐用年数,
        simulation.構築物_償却方法,
        simulation.構築物_残存価額
    )
    
    return 建物 + 付属設備 + 構築物
```

### 4. シミュレーション実行時の処理

**ファイル**: `app/blueprints/property/views.py`

- シミュレーション作成時に合計減価償却費を計算
- `減価償却費`フィールドに自動計算結果を保存
- シミュレーション結果の計算時に使用

---

## 🎯 物件ベースシミュレーションの対応

### 物件データからの自動取得

物件ベースシミュレーションの場合、物件データから以下の情報を取得：

1. **T_物件テーブル**から取得価額を取得
2. **取得価額を3つに分割**（デフォルトの割合）
   - 建物部分: 70%
   - 建物付属設備: 20%
   - 構築物: 10%

3. **耐用年数はデフォルト値を使用**
   - 建物部分: 47年（RC造の場合）
   - 建物付属設備: 15年
   - 構築物: 20年

4. **ユーザーが手動で変更可能**
   - フォームで各項目を編集できる

---

## 📝 実装の優先順位

### Phase 1: データベーススキーマの拡張

1. モデル定義を修正
2. 自動マイグレーション機能でカラムを追加

### Phase 2: フォームの修正

1. 新しいフィールドをフォームに追加
2. JavaScriptで自動計算機能を実装

### Phase 3: 計算ロジックの実装

1. 減価償却費計算関数を作成
2. シミュレーション作成時に自動計算

### Phase 4: テストとデプロイ

1. ローカル環境でテスト
2. GitHubにプッシュ
3. Herokuにデプロイ
4. 本番環境で動作確認

---

## 🔍 注意事項

### 定率法の扱い

定率法の場合、毎年の減価償却費が変動するため：

1. **初年度の減価償却費を計算**
2. **シミュレーション結果テーブルで年度ごとに再計算**
3. **期首帳簿価額を更新しながら計算**

### 残存価額の扱い

- 平成19年4月1日以降の取得資産は残存価額が1円
- ユーザーが手動で設定可能
- デフォルトは0円

### 耐用年数の目安

**建物**（構造別）:
- RC造（鉄筋コンクリート造）: 47年
- 重量鉄骨造: 34年
- 軽量鉄骨造: 27年
- 木造: 22年

**建物付属設備**:
- 電気設備: 15年
- 給排水設備: 15年
- 冷暖房設備: 15年

**構築物**:
- アスファルト舗装: 10年
- コンクリート舗装: 15年
- 門・塀: 20年

---

**仕様書作成者**: Manus AI  
**最終更新**: 2026年1月3日 17:10 JST
