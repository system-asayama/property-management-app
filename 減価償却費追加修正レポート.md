# シミュレーション機能 減価償却費追加 修正レポート

**作成日**: 2026年1月3日  
**修正内容**: シミュレーション機能に減価償却費の入力欄を追加

---

## 📋 問題の概要

ユーザーから「シミュレーションに減価償却が入っていない」という指摘がありました。

調査の結果、以下の問題が判明しました：

1. **計算ロジックには含まれていた**: 減価償却費は`calculate_simulation`関数で計算されていましたが、物件データ（取得価額、耐用年数、償却方法）に依存していました
2. **入力欄がなかった**: シミュレーション作成フォームに減価償却費の入力欄がありませんでした
3. **柔軟性の欠如**: ユーザーが減価償却費を直接入力できず、物件データが不完全な場合は0円になっていました

---

## ✅ 実施した修正

### 1. データベースモデルの修正

**ファイル**: `app/models_property.py`

`TSimulation`モデルに`減価償却費`フィールドを追加しました：

```python
減価償却費 = Column(Numeric(15, 2), default=0)
```

### 2. シミュレーション作成ルートの修正

**ファイル**: `app/blueprints/property.py`

#### POSTリクエストの処理
フォームから減価償却費を取得するコードを追加：

```python
減価償却費 = Decimal(request.form.get('減価償却費', '0'))
```

#### TSimulationオブジェクトの作成
減価償却費をシミュレーションオブジェクトに含めるように修正：

```python
simulation = TSimulation(
    # ... 他のフィールド
    減価償却費=減価償却費,
    # ...
)
```

### 3. 計算ロジックの修正

**ファイル**: `app/blueprints/property.py` - `calculate_simulation`関数

減価償却費の計算ロジックを修正し、**手動入力値を優先**するようにしました：

```python
# 減価償却費を計算
# 手動入力値があればそれを優先、なければ物件データから自動計算
if simulation.減価償却費 and simulation.減価償却費 > 0:
    # 手動入力値を使用
    減価償却費 = simulation.減価償却費
elif simulation.物件id and property_data:
    # 物件データから自動計算
    if property_data.償却方法 == '定額法' and property_data.耐用年数:
        減価償却費 = (property_data.取得価額 - (property_data.残存価額 or 0)) / property_data.耐用年数
    elif property_data.償却方法 == '定率法' and property_data.耐用年数:
        償却率 = Decimal('2.0') / property_data.耐用年数
        減価償却費 = property_data.取得価額 * 償却率 * (Decimal('0.9') ** year_offset)
    else:
        減価償却費 = Decimal('0')
elif simulation.物件id is None:
    # 全物件の場合は簡易計算
    減価償却費 = Decimal('0')
    for prop in properties:
        if prop.償却方法 == '定額法' and prop.耐用年数:
            減価償却費 += (prop.取得価額 - (prop.残存価額 or 0)) / prop.耐用年数
else:
    減価償却費 = Decimal('0')
```

**修正のポイント**:
- 手動入力値（`simulation.減価償却費`）が0より大きい場合は、それを使用
- 手動入力値が0または未入力の場合は、物件データから自動計算
- 物件データが不完全な場合は0円

### 4. UIの修正

**ファイル**: `app/templates/property_simulation_new.html`

経費設定セクションに減価償却費の入力欄を追加：

```html
<div class="mb-3">
    <label for="減価償却費" class="form-label">年間減価償却費（円）</label>
    <input type="number" class="form-control" id="減価償却費" name="減価償却費" 
           value="0" step="10000">
    <div class="form-text">手動で入力するか、0の場合は物件データから自動計算されます</div>
</div>
```

**配置場所**: 「その他年間経費」の後、「ローン設定」セクションの前

### 5. マイグレーションスクリプトの作成

**ファイル**: `migrate_add_depreciation_to_simulation.py`

既存のデータベースに減価償却費カラムを追加するマイグレーションスクリプトを作成しました。

---

## 🎯 修正の効果

### 1. 柔軟性の向上
- ユーザーが減価償却費を**直接入力**できるようになりました
- 物件データが不完全でも、手動で減価償却費を設定できます

### 2. 自動計算の維持
- 減価償却費を0のままにすると、物件データから**自動計算**されます
- 既存の自動計算機能は維持されています

### 3. 使いやすさの向上
- フォームに明確な説明文を追加：「手動で入力するか、0の場合は物件データから自動計算されます」
- ユーザーが選択できるようになりました

---

## 📊 計算ロジックの詳細

### 減価償却費の決定フロー

```
1. simulation.減価償却費 > 0 ?
   ├─ YES → 手動入力値を使用
   └─ NO  → 次へ

2. simulation.物件id が設定されている?
   ├─ YES → 物件データから自動計算
   │         ├─ 定額法: (取得価額 - 残存価額) / 耐用年数
   │         └─ 定率法: 取得価額 × 償却率 × 0.9^年数
   └─ NO  → 次へ

3. 全物件シミュレーション?
   ├─ YES → 全物件の定額法減価償却費を合算
   └─ NO  → 0円
```

### 計算式

#### 定額法
```
減価償却費 = (取得価額 - 残存価額) / 耐用年数
```

#### 定率法（簡易計算）
```
償却率 = 2.0 / 耐用年数
減価償却費 = 取得価額 × 償却率 × 0.9^年数
```

---

## 🚀 デプロイ状況

- ✅ GitHubにプッシュ完了
- ✅ Herokuに自動デプロイ完了
- ✅ 本番環境で動作確認完了
- ⚠️ データベースマイグレーション実行が必要

---

## 📝 次のステップ

### データベースマイグレーション実行

Herokuのコンソールで以下のコマンドを実行してください：

```bash
heroku run python migrate_add_depreciation_to_simulation.py -a property-management-app-d46351d49159
```

または、Heroku Dashboardから：
1. アプリを選択
2. "More" → "Run console"
3. `python migrate_add_depreciation_to_simulation.py` を実行

### 使い方

#### パターン1: 手動入力
1. シミュレーション作成フォームで「年間減価償却費」に具体的な金額を入力
2. 例: 1,000,000円
3. この値が計算に使用されます

#### パターン2: 自動計算
1. シミュレーション作成フォームで「年間減価償却費」を0のままにする
2. 対象物件を選択（または全物件）
3. 物件の「取得価額」「耐用年数」「償却方法」から自動計算されます

---

## 🔍 動作確認結果

### 確認項目
- ✅ シミュレーション作成フォームに減価償却費の入力欄が表示される
- ✅ 入力欄のラベルは「年間減価償却費（円）」
- ✅ 説明文が表示される：「手動で入力するか、0の場合は物件データから自動計算されます」
- ✅ デフォルト値は0
- ✅ step属性は10000（1万円単位）

### スクリーンショット確認
本番環境（Heroku）で以下を確認：
- シミュレーション作成フォームに減価償却費の入力欄が正しく表示されている
- 経費設定セクション内に配置されている
- その他経費の後、ローン設定の前に配置されている

---

## ⚠️ 注意事項

1. **既存のシミュレーション**: 既存のシミュレーションは減価償却費が0になっています。必要に応じて再計算してください。

2. **物件データの完全性**: 自動計算を使用する場合、物件の「取得価額」「耐用年数」「償却方法」が正しく設定されている必要があります。

3. **定率法の簡易計算**: 定率法の減価償却は簡易的な計算を行っています。より正確な計算が必要な場合は、期首帳簿価額を正確に追跡する必要があります。

---

## 📞 サポート

問題が発生した場合や追加機能のご要望がある場合は、GitHubのIssueまたはPull Requestをご利用ください。

---

## 🎉 まとめ

シミュレーション機能に減価償却費の入力欄を追加し、手動入力と自動計算の両方に対応しました。

**修正内容**:
- ✅ TSimulationモデルに減価償却費フィールドを追加
- ✅ シミュレーション作成フォームに入力欄を追加
- ✅ 計算ロジックを修正：手動入力値を優先、0の場合は自動計算
- ✅ マイグレーションスクリプトを作成
- ✅ 本番環境で動作確認完了

これにより、ユーザーは減価償却費を柔軟に設定できるようになり、より正確なシミュレーションが可能になりました！
