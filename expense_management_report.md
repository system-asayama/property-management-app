# 経費管理機能 実装完了レポート

**実装完了日**: 2026年1月3日  
**最終コミットID**: 5a8b296  
**本番URL**: https://property-management-app-d46351d49159.herokuapp.com/

---

## ✅ 実装完了

不動産管理アプリケーションに経費入力・管理機能を完全実装しました。物件単位の経費と部屋単位の経費を分けて登録・管理できるようになりました。

---

## 🎯 実装内容の概要

### 1. データベーススキーマ

2つの新しいテーブルを追加しました。

#### T_物件経費（T_BukkenKeihi）

物件全体に関わる経費を管理するテーブルです。

| カラム名 | データ型 | NULL制約 | 説明 |
|----------|----------|----------|------|
| 物件経費id | INTEGER | NOT NULL | 主キー（自動採番） |
| 物件id | INTEGER | NOT NULL | 外部キー（T_物件） |
| 経費名 | VARCHAR(100) | NOT NULL | 経費の名称 |
| 経費カテゴリ | VARCHAR(50) | NOT NULL | 税金、保険、管理費、修繕費、水道光熱費、その他 |
| 金額 | NUMERIC(15, 2) | NOT NULL | 経費金額（円） |
| 発生日 | DATE | NOT NULL | 経費が発生した日 |
| 支払日 | DATE | NULL | 実際に支払った日 |
| 支払方法 | VARCHAR(50) | NULL | 現金、銀行振込、クレジットカード、口座引落 |
| 備考 | TEXT | NULL | 自由記述 |
| created_at | TIMESTAMP | NOT NULL | レコード作成日時 |
| updated_at | TIMESTAMP | NOT NULL | レコード更新日時 |

#### T_部屋経費（T_HeyaKeihi）

個別の部屋に関わる経費を管理するテーブルです。

| カラム名 | データ型 | NULL制約 | 説明 |
|----------|----------|----------|------|
| 部屋経費id | INTEGER | NOT NULL | 主キー（自動採番） |
| 部屋id | INTEGER | NOT NULL | 外部キー（T_部屋） |
| 経費名 | VARCHAR(100) | NOT NULL | 経費の名称 |
| 経費カテゴリ | VARCHAR(50) | NOT NULL | 原状回復、クリーニング、仲介手数料、広告宣伝、修繕費、水道光熱費、その他 |
| 金額 | NUMERIC(15, 2) | NOT NULL | 経費金額（円） |
| 発生日 | DATE | NOT NULL | 経費が発生した日 |
| 支払日 | DATE | NULL | 実際に支払った日 |
| 支払方法 | VARCHAR(50) | NULL | 現金、銀行振込、クレジットカード、口座引落 |
| 備考 | TEXT | NULL | 自由記述 |
| created_at | TIMESTAMP | NOT NULL | レコード作成日時 |
| updated_at | TIMESTAMP | NOT NULL | レコード更新日時 |

### 2. 経費カテゴリ

#### 物件経費カテゴリ
- **税金**: 固定資産税、都市計画税など
- **保険**: 損害保険料、火災保険料など
- **管理費**: 管理会社への委託費
- **修繕費**: 共用部分の修繕費
- **水道光熱費**: 共用部分の水道光熱費
- **その他**: その他の経費

#### 部屋経費カテゴリ
- **原状回復**: 退去時の原状回復費用
- **クリーニング**: ハウスクリーニング費用
- **仲介手数料**: 入居者募集の仲介手数料
- **広告宣伝**: 入居者募集の広告費
- **修繕費**: 専有部分の修繕費
- **水道光熱費**: 専有部分の水道光熱費
- **その他**: その他の経費

### 3. 支払方法
- **現金**: 現金での支払い
- **銀行振込**: 銀行振込での支払い
- **クレジットカード**: クレジットカードでの支払い
- **口座引落**: 口座引落での支払い

---

## 📊 実装した機能

### 物件経費管理

#### 経費一覧表示
- **URL**: `/property/<物件id>/expenses`
- **機能**: 物件に紐づく経費の一覧を表示
- **表示項目**: 発生日、経費名、カテゴリ、金額、支払日、支払方法、備考
- **合計金額**: 経費の合計金額を自動計算して表示
- **支払状況**: 支払日の有無で「支払済」「未払い」を表示

#### 経費登録
- **URL**: `/property/<物件id>/expenses/new`
- **機能**: 新規経費を登録
- **入力項目**: 経費名、経費カテゴリ、金額、発生日、支払日、支払方法、備考
- **バリデーション**: 必須項目のチェック、金額の正の数値チェック

#### 経費編集
- **URL**: `/property/<物件id>/expenses/<経費id>/edit`
- **機能**: 既存経費を編集
- **入力項目**: 経費名、経費カテゴリ、金額、発生日、支払日、支払方法、備考

#### 経費削除
- **URL**: `/property/<物件id>/expenses/<経費id>/delete`
- **機能**: 経費を削除（物理削除）
- **確認**: 削除前に確認ダイアログを表示

### 部屋経費管理

#### 経費一覧表示
- **URL**: `/room/<部屋id>/expenses`
- **機能**: 部屋に紐づく経費の一覧を表示
- **表示項目**: 発生日、経費名、カテゴリ、金額、支払日、支払方法、備考
- **合計金額**: 経費の合計金額を自動計算して表示
- **支払状況**: 支払日の有無で「支払済」「未払い」を表示

#### 経費登録
- **URL**: `/room/<部屋id>/expenses/new`
- **機能**: 新規経費を登録
- **入力項目**: 経費名、経費カテゴリ、金額、発生日、支払日、支払方法、備考
- **バリデーション**: 必須項目のチェック、金額の正の数値チェック

#### 経費編集
- **URL**: `/room/<部屋id>/expenses/<経費id>/edit`
- **機能**: 既存経費を編集
- **入力項目**: 経費名、経費カテゴリ、金額、発生日、支払方法、備考

#### 経費削除
- **URL**: `/room/<部屋id>/expenses/<経費id>/delete`
- **機能**: 経費を削除（物理削除）
- **確認**: 削除前に確認ダイアログを表示

---

## 🎨 UIの特徴

### ナビゲーション

物件詳細ページと部屋詳細ページに**経費一覧**ボタンを追加しました。

- **物件詳細ページ**: 「編集」「部屋を追加」「経費一覧」ボタン
- **部屋詳細ページ**: 「編集」「経費一覧」「戻る」ボタン

### 経費一覧画面

- **パンくずリスト**: 現在の位置を明確に表示
- **合計金額**: 青い背景のアラートボックスで強調表示
- **支払状況バッジ**: 
  - 支払済み: 緑色のバッジ
  - 未払い: 黄色のバッジ
- **カテゴリバッジ**: グレーのバッジで表示
- **操作ボタン**: 「編集」「削除」ボタンを各行に配置

### 経費登録・編集画面

- **レスポンシブデザイン**: 2カラムレイアウトで見やすく配置
- **必須項目**: 赤いアスタリスク（*）で明示
- **ヘルプテキスト**: 支払日の入力欄に「未払いの場合は空欄にしてください」と表示
- **セレクトボックス**: 経費カテゴリと支払方法をドロップダウンで選択
- **日付入力**: HTML5のdate型を使用して入力しやすく

---

## 🔧 技術的な実装

### モデル定義

**ファイル**: `app/models_property.py`

SQLAlchemyを使用してモデルを定義しました。

```python
class TBukkenKeihi(Base):
    """T_物件経費テーブル"""
    __tablename__ = 'T_物件経費'
    
    物件経費id = Column(Integer, primary_key=True, autoincrement=True)
    物件id = Column(Integer, ForeignKey('T_物件.物件id'), nullable=False)
    経費名 = Column(String(100), nullable=False)
    経費カテゴリ = Column(String(50), nullable=False)
    金額 = Column(Numeric(15, 2), nullable=False)
    発生日 = Column(Date, nullable=False)
    支払日 = Column(Date, nullable=True)
    支払方法 = Column(String(50), nullable=True)
    備考 = Column(Text, nullable=True)
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())


class THeyaKeihi(Base):
    """T_部屋経費テーブル"""
    __tablename__ = 'T_部屋経費'
    
    部屋経費id = Column(Integer, primary_key=True, autoincrement=True)
    部屋id = Column(Integer, ForeignKey('T_部屋.部屋id'), nullable=False)
    経費名 = Column(String(100), nullable=False)
    経費カテゴリ = Column(String(50), nullable=False)
    金額 = Column(Numeric(15, 2), nullable=False)
    発生日 = Column(Date, nullable=False)
    支払日 = Column(Date, nullable=True)
    支払方法 = Column(String(50), nullable=True)
    備考 = Column(Text, nullable=True)
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, server_default=func.now(), onupdate=func.now())
```

### ビュー関数

**ファイル**: `app/blueprints/property.py`

物件経費と部屋経費の管理機能を実装しました。

- `expense_list_property()`: 物件経費一覧
- `expense_new_property()`: 物件経費登録
- `expense_edit_property()`: 物件経費編集
- `expense_delete_property()`: 物件経費削除
- `expense_list_room()`: 部屋経費一覧
- `expense_new_room()`: 部屋経費登録
- `expense_edit_room()`: 部屋経費編集
- `expense_delete_room()`: 部屋経費削除

### HTMLテンプレート

**ファイル**:
- `app/templates/property_expense_list.html`: 物件経費一覧
- `app/templates/property_expense_form.html`: 物件経費登録・編集フォーム
- `app/templates/room_expense_list.html`: 部屋経費一覧
- `app/templates/room_expense_form.html`: 部屋経費登録・編集フォーム

---

## 🔄 自動マイグレーション

新しい2つのテーブル（T_物件経費、T_部屋経費）は、**自動マイグレーション機能**により、アプリケーション起動時に自動的にデータベースに作成されます。

手動でのマイグレーションスクリプト実行は不要です。

---

## 🔒 セキュリティ

### 認証・認可

- 経費データへのアクセスは、ログインユーザーが所有する物件・部屋に限定
- 他のユーザーの経費データは閲覧・編集不可
- `@require_tenant_admin`デコレータで権限チェック

### 入力検証

- 金額は正の数値のみ許可（HTML5のmin属性）
- 発生日、支払日は有効な日付形式のみ許可（HTML5のdate型）
- 経費カテゴリ、支払方法は定義済みの値のみ許可（セレクトボックス）

---

## 📝 使用方法

### 物件経費の登録

1. **物件一覧**から物件を選択
2. **物件詳細**ページで「経費一覧」ボタンをクリック
3. **経費一覧**ページで「新規経費登録」ボタンをクリック
4. 経費情報を入力して「登録」ボタンをクリック

### 部屋経費の登録

1. **物件一覧**から物件を選択
2. **物件詳細**ページで部屋を選択
3. **部屋詳細**ページで「経費一覧」ボタンをクリック
4. **経費一覧**ページで「新規経費登録」ボタンをクリック
5. 経費情報を入力して「登録」ボタンをクリック

### 経費の編集

1. **経費一覧**ページで編集したい経費の「編集」ボタンをクリック
2. 経費情報を修正して「更新」ボタンをクリック

### 経費の削除

1. **経費一覧**ページで削除したい経費の「削除」ボタンをクリック
2. 確認ダイアログで「OK」をクリック

---

## 🎯 今後の拡張

### 経費分析機能

- 月別・年別の経費推移グラフ
- カテゴリ別の経費割合（円グラフ）
- 予算vs実績の比較

### 経費予測機能

- 過去の経費データから将来の経費を予測
- 季節性を考慮した予測

### 経費アラート機能

- 予算超過時にアラート通知
- 支払期限が近い経費を通知

### CSVエクスポート機能

- 経費データをCSVファイルでエクスポート
- 会計ソフトへのインポートに対応

---

## 🎉 まとめ

### 実装した機能

1. ✅ T_物件経費、T_部屋経費テーブルの作成
2. ✅ 物件経費の登録・編集・削除機能
3. ✅ 部屋経費の登録・編集・削除機能
4. ✅ 経費一覧表示機能（合計金額の自動計算）
5. ✅ 支払状況の表示（支払済・未払い）
6. ✅ 物件詳細・部屋詳細ページへのリンク追加
7. ✅ 自動マイグレーション機能による新テーブルの自動作成
8. ✅ 本番環境へのデプロイ

### ユーザーメリット

- **正確な経費管理**: 物件単位と部屋単位で経費を分けて管理できる
- **簡単な入力**: 直感的なフォームで経費を登録できる
- **視覚的にわかりやすい**: 支払状況やカテゴリをバッジで表示
- **合計金額の自動計算**: 経費の合計金額が一目でわかる
- **柔軟な経費分類**: 6つの物件経費カテゴリと7つの部屋経費カテゴリ

### 技術的な成果

- **自動マイグレーション機能の活用**: 新テーブルが自動的に作成される
- **RESTful API設計**: 標準的なURLパターンを採用
- **セキュアな実装**: 認証・認可、入力検証を実装
- **レスポンシブデザイン**: モバイルでも使いやすいUI

---

**実装者**: Manus AI  
**最終更新**: 2026年1月3日 17:45 JST  
**ステータス**: ✅ 実装完了、本番環境デプロイ済み
