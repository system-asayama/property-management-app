# ローン返済額自動計算機能 実装レポート

## 概要

シミュレーション作成・編集フォームに、ローン返済額の自動計算機能を実装しました。借入金額、返済期間、返済方法、金利を入力すると、年間返済額が自動的に計算されます。

## 実装内容

### 1. データベーススキーマの拡張

**TSimulationモデルに追加したフィールド:**

| フィールド名 | 型 | 説明 |
|------------|-----|------|
| 借入金額 | Numeric(15, 2) | ローンの総借入金額 |
| 返済期間_年 | Integer | 返済期間（年数） |
| 返済方法 | String(20) | '元利均等' または '元金均等' |
| 返済開始日 | Date | ローン返済の開始日 |

### 2. バックエンド計算関数

**calculate_loan_payment関数を実装:**

```python
def calculate_loan_payment(principal, annual_rate, years, method='元利均等'):
    """
    ローン返済額を計算（年間）
    
    Args:
        principal: 借入金額（円）
        annual_rate: 年利（%）
        years: 返済期間（年）
        method: 返済方法（'元利均等' or '元金均等'）
    
    Returns:
        年間返済額（円）
    """
```

**対応する返済方法:**

#### 元利均等返済
- 毎月の返済額が一定
- 計算式: 月額返済額 = 借入金額 × 月利 × (1 + 月利)^返済回数 / ((1 + 月利)^返済回数 - 1)
- 年間返済額 = 月額返済額 × 12

#### 元金均等返済
- 元金部分が一定、利息が逓減
- 初年度の返済額を計算（1～12ヶ月目の合計）
- 毎月の元金返済額は一定、利息は残高に応じて減少

### 3. フロントエンド自動計算機能

**JavaScriptによるリアルタイム計算:**

```javascript
function calculateLoanPayment() {
    const principal = parseFloat(document.getElementById('借入金額').value) || 0;
    const rate = parseFloat(document.getElementById('ローン金利').value) || 0;
    const years = parseInt(document.getElementById('返済期間_年').value) || 0;
    const method = document.getElementById('返済方法').value;
    
    if (principal > 0 && years > 0 && method) {
        // 元利均等または元金均等で計算
        // 結果を自動的にフォームに反映
    }
}
```

**トリガー:**
- 借入金額の変更時
- 返済期間の変更時
- 返済方法の変更時
- ローン金利の変更時

### 4. ユーザーインターフェース

**シミュレーション作成・編集フォームの構成:**

```
┌─────────────────────────────────────┐
│ ローン設定                           │
├─────────────────────────────────────┤
│ 📊 ローン返済額自動計算              │
│ 以下の情報を入力すると、年間返済額が │
│ 自動計算されます。                   │
│                                     │
│ ┌─────────┐  ┌─────────┐          │
│ │借入金額  │  │返済期間  │          │
│ └─────────┘  └─────────┘          │
│                                     │
│ ┌─────────┐  ┌─────────┐          │
│ │返済方法  │  │返済開始日│          │
│ └─────────┘  └─────────┘          │
│                                     │
│ ─────────────────────────────────  │
│                                     │
│ ┌─────────┐                        │
│ │ローン残高│ (自動設定)             │
│ └─────────┘                        │
│                                     │
│ ┌─────────┐  ┌─────────────┐      │
│ │ローン金利│  │年間返済額    │      │
│ └─────────┘  │(自動計算) 🟢│      │
│              └─────────────┘      │
└─────────────────────────────────────┘
```

## 計算例

### 例1: 元利均等返済

**入力:**
- 借入金額: 30,000,000円
- 返済期間: 35年
- 返済方法: 元利均等
- 金利: 2.0%

**計算結果:**
- 月額返済額: 99,378円
- **年間返済額: 1,192,545円**

### 例2: 元金均等返済

**入力:**
- 借入金額: 30,000,000円
- 返済期間: 35年
- 返済方法: 元金均等
- 金利: 2.0%

**計算結果:**
- 初回月額返済額: 121,428円
- **初年度年間返済額: 1,449,285円**

### 例3: 金利0%の場合

**入力:**
- 借入金額: 10,000,000円
- 返済期間: 10年
- 返済方法: 元利均等
- 金利: 0%

**計算結果:**
- 月額返済額: 83,333円
- **年間返済額: 1,000,000円**

## 使用方法

### 新規シミュレーション作成時

1. シミュレーション新規作成ページにアクセス
2. 「ローン設定」セクションで以下を入力:
   - 借入金額（必須）
   - 返済期間（必須）
   - 返済方法（必須）
   - ローン金利（必須）
   - 返済開始日（任意）
3. 入力すると自動的に年間返済額が計算される
4. ローン残高も自動的に借入金額と同じ値に設定される
5. 「作成」ボタンをクリックしてシミュレーションを保存

### 既存シミュレーション編集時

1. シミュレーション一覧から「編集」ボタンをクリック
2. 「ローン設定」セクションでローン詳細情報を入力または変更
3. 変更すると自動的に年間返済額が再計算される
4. 「更新」ボタンをクリックして変更を保存

## 技術的な詳細

### 自動マイグレーション

新しいフィールドは自動的にデータベースに追加されます。既存のシミュレーションには影響しません。

### 互換性

- 既存のシミュレーション: ローン詳細情報がNULLのまま維持される
- 手動入力: ローン詳細情報を入力しない場合は、従来通り手動で年間返済額を入力可能
- 自動計算: ローン詳細情報を入力すると、自動的に年間返済額が計算される

### バリデーション

**入力チェック:**
- 借入金額 > 0
- 返済期間 > 0
- 返済方法が選択されている

上記の条件を満たす場合のみ自動計算が実行されます。

### 計算精度

- Decimal型を使用して高精度な計算を実現
- 端数は四捨五入して整数値で表示
- JavaScriptとPythonで同じ計算ロジックを使用

## デプロイ状況

✅ すべての変更をGitHubにプッシュ済み
✅ Herokuで自動デプロイ完了
✅ 本番環境で利用可能

## まとめ

ローン返済額の自動計算機能により、以下の改善が実現しました:

**利便性の向上:**
- 手動計算が不要になり、入力ミスを防止
- リアルタイムで返済額を確認可能
- 複数のシミュレーションを素早く作成可能

**正確性の向上:**
- 元利均等・元金均等の正確な計算式を実装
- 金利0%のケースにも対応
- 高精度な計算により信頼性の高いシミュレーション

**柔軟性の維持:**
- 自動計算と手動入力の両方に対応
- 既存のシミュレーションとの互換性を維持
- 必要に応じて返済額を手動で調整可能

これにより、不動産投資シミュレーションの精度と使いやすさが大幅に向上しました。
