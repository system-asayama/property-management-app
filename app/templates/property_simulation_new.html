{% extends "base.html" %}

{% block title %}新規シミュレーション作成 - 不動産管理{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>新規シミュレーション作成</h2>
    
    <form method="POST" action="{{ url_for('property.simulation_new') }}" id="simulationForm">
        <!-- 基本情報 -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">基本情報</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="名称" class="form-label">シミュレーション名 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="名称" name="名称" required>
                </div>
                
                <div class="mb-3">
                    <label for="シミュレーション種別" class="form-label">シミュレーション種別 <span class="text-danger">*</span></label>
                    <select class="form-select" id="シミュレーション種別" name="シミュレーション種別" required onchange="toggleSimulationType()">
                        <option value="物件ベース">物件ベース（既存物件データを使用）</option>
                        <option value="独立">独立シミュレーション（手動入力）</option>
                    </select>
                    <div class="form-text">
                        <strong>物件ベース:</strong> 登録済みの物件データから家賃収入などを自動取得します。<br>
                        <strong>独立シミュレーション:</strong> 物件データに依存せず、すべて手動で入力します。
                    </div>
                </div>
                
                <!-- 物件ベースシミュレーション用 -->
                <div id="propertyBasedFields">
                    <div class="mb-3">
                        <label for="物件id" class="form-label">対象物件</label>
                        <select class="form-select" id="物件id" name="物件id">
                            <option value="">全物件</option>
                            {% for property in properties %}
                            <option value="{{ property.id }}">{{ property.物件名 }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">物件を選択しない場合、全物件の合算でシミュレーションします。</div>
                    </div>
                </div>
                
                <!-- 独立シミュレーション用 -->
                <div id="independentFields" style="display: none;">
                    <div class="mb-3">
                        <label for="年間家賃収入" class="form-label">年間家賃収入（円） <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="年間家賃収入" name="年間家賃収入" min="0" step="1">
                        <div class="form-text">満室時の年間家賃収入を入力してください。</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="部屋数" class="form-label">部屋数</label>
                        <input type="number" class="form-control" id="部屋数" name="部屋数" min="1" step="1">
                        <div class="form-text">参考情報として入力してください。</div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="開始年度" class="form-label">開始年度 <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="開始年度" name="開始年度" value="{{ current_year }}" min="2000" max="2100" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="期間" class="form-label">期間（年） <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="期間" name="期間" value="10" min="1" max="50" required>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 収入設定 -->
        <div class="card mb-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">収入設定</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="稼働率" class="form-label">稼働率（%）</label>
                    <input type="number" class="form-control" id="稼働率" name="稼働率" value="95.00" min="0" max="100" step="0.01">
                    <div class="form-text">空室率を考慮した稼働率を入力してください。</div>
                </div>
                
                <div class="mb-3">
                    <label for="その他収入" class="form-label">その他収入（年間、円）</label>
                    <input type="number" class="form-control" id="その他収入" name="その他収入" value="0" min="0" step="1">
                    <div class="form-text">駐車場収入、礼金、更新料などの年間合計額を入力してください。</div>
                </div>
            </div>
        </div>
        
        <!-- 経費設定 -->
        <div class="card mb-3">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">経費設定</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="管理費率" class="form-label">管理費率（%）</label>
                        <input type="number" class="form-control" id="管理費率" name="管理費率" value="5.00" min="0" max="100" step="0.01">
                        <div class="form-text">家賃収入に対する管理費の割合</div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="修繕費率" class="form-label">修繕費率（%）</label>
                        <input type="number" class="form-control" id="修繕費率" name="修繕費率" value="5.00" min="0" max="100" step="0.01">
                        <div class="form-text">家賃収入に対する修繕費の割合</div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="固定資産税" class="form-label">固定資産税（年間、円）</label>
                        <input type="number" class="form-control" id="固定資産税" name="固定資産税" value="0" min="0" step="1">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="損害保険料" class="form-label">損害保険料（年間、円）</label>
                        <input type="number" class="form-control" id="損害保険料" name="損害保険料" value="0" min="0" step="1">
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="減価償却費" class="form-label">年間減価償却費（円）</label>
                    <input type="number" class="form-control" id="減価償却費" name="減価償却費" value="0" min="0" step="1">
                    <div class="form-text">手動で入力するか、0の場合は物件データから自動計算されます（物件ベースのみ）。</div>
                </div>
                
                <div class="mb-3">
                    <label for="その他経費" class="form-label">その他経費（年間、円）</label>
                    <input type="number" class="form-control" id="その他経費" name="その他経費" value="0" min="0" step="1">
                    <div class="form-text">水道光熱費、通信費、交通費などの年間合計額を入力してください。</div>
                </div>
            </div>
        </div>
        
        <!-- ローン設定 -->
        <div class="card mb-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">ローン設定</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="ローン残高" class="form-label">ローン残高（円）</label>
                    <input type="number" class="form-control" id="ローン残高" name="ローン残高" value="0" min="0" step="1">
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="ローン金利" class="form-label">ローン金利（%）</label>
                        <input type="number" class="form-control" id="ローン金利" name="ローン金利" value="0" min="0" max="100" step="0.01">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="ローン年間返済額" class="form-label">ローン年間返済額（円）</label>
                        <input type="number" class="form-control" id="ローン年間返済額" name="ローン年間返済額" value="0" min="0" step="1">
                        <div class="form-text">元本+利息の合計額</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 税金設定 -->
        <div class="card mb-3">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">税金設定</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="その他所得" class="form-label">その他所得（年間、円）</label>
                    <input type="number" class="form-control" id="その他所得" name="その他所得" value="0" min="0" step="1">
                    <div class="form-text">給与所得など、不動産所得以外の所得を入力してください。</div>
                </div>
                
                <div class="alert alert-info">
                    <strong>税率について:</strong><br>
                    税率は所得金額に応じて自動計算されます。<br>
                    <small>
                        • 195万円以下: 15%<br>
                        • 195万円超〜330万円以下: 20%<br>
                        • 330万円超〜695万円以下: 30%<br>
                        • 695万円超〜900万円以下: 33%<br>
                        • 900万円超〜1,800万円以下: 43%<br>
                        • 1,800万円超〜4,000万円以下: 50%<br>
                        • 4,000万円超: 55%
                    </small>
                </div>
            </div>
        </div>
        
        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a href="{{ url_for('property.simulations') }}" class="btn btn-secondary">キャンセル</a>
            <button type="submit" class="btn btn-primary">シミュレーションを作成</button>
        </div>
    </form>
</div>

<script>
function toggleSimulationType() {
    const simulationType = document.getElementById('シミュレーション種別').value;
    const propertyBasedFields = document.getElementById('propertyBasedFields');
    const independentFields = document.getElementById('independentFields');
    const 年間家賃収入Input = document.getElementById('年間家賃収入');
    
    if (simulationType === '独立') {
        // 独立シミュレーション
        propertyBasedFields.style.display = 'none';
        independentFields.style.display = 'block';
        年間家賃収入Input.required = true;
        document.getElementById('物件id').value = '';
    } else {
        // 物件ベース
        propertyBasedFields.style.display = 'block';
        independentFields.style.display = 'none';
        年間家賃収入Input.required = false;
        document.getElementById('年間家賃収入').value = '';
        document.getElementById('部屋数').value = '';
    }
}

// ページ読み込み時に初期状態を設定
document.addEventListener('DOMContentLoaded', function() {
    toggleSimulationType();
});
</script>
{% endblock %}
