# 減価償却費自動計算機能 最終実装レポート

**実装完了日**: 2026年1月3日  
**最終コミットID**: 73ebd9a  
**本番URL**: https://property-management-app-d46351d49159.herokuapp.com/property/simulations/new

---

## ✅ 実装完了

シミュレーション機能に減価償却費の自動計算機能を完全実装しました。

---

## 🎯 実装内容の概要

### 1. 3分割方式の減価償却設定

減価償却費を以下の3つに分けて設定できるようになりました：

#### ① 建物部分
- 取得価額、耐用年数（デフォルト47年）、償却方法、残存価額
- 年間減価償却費を自動計算

#### ② 建物付属設備
- 取得価額、耐用年数（デフォルト15年）、償却方法、残存価額
- 年間減価償却費を自動計算

#### ③ 構築物
- 取得価額、耐用年数（デフォルト20年）、償却方法、残存価額
- 年間減価償却費を自動計算

### 2. リアルタイム自動計算

- **oninputイベント**: 入力中にリアルタイムで自動計算
- **onchangeイベント**: 入力完了後に自動計算
- 両方のイベントをサポートすることで、確実に自動計算が実行される

### 3. 償却方法の選択

- **定額法**: (取得価額 - 残存価額) ÷ 耐用年数
- **定率法**: 取得価額 × (2 ÷ 耐用年数) ※初年度

### 4. 対応範囲

- ✅ 独立シミュレーション
- ✅ 物件ベースシミュレーション

---

## 📊 実装したファイル

### 1. モデル定義（app/models_property.py）

12個の新フィールドを追加：
- 建物_取得価額、建物_耐用年数、建物_償却方法、建物_残存価額
- 付属設備_取得価額、付属設備_耐用年数、付属設備_償却方法、付属設備_残存価額
- 構築物_取得価額、構築物_耐用年数、構築物_償却方法、構築物_残存価額

### 2. ビュー関数（app/blueprints/property.py）

- シミュレーション作成時に12個の新フィールドを受け取る
- `calculate_simulation()`関数で3分割方式の減価償却費を計算

### 3. HTMLテンプレート（app/templates/property_simulation_new.html）

- 減価償却設定セクションを追加
- 建物、建物付属設備、構築物の3つのサブセクション
- JavaScriptでリアルタイム自動計算
- oninputとonchangeの両方をサポート

---

## 🧪 テスト結果

### テストケース1: 建物のみ

**入力**:
- 建物_取得価額: 10,000,000円
- 建物_耐用年数: 47年
- 建物_償却方法: 定額法
- 建物_残存価額: 0円

**結果**:
- 建物_年間減価償却費: **212,765.957円** ✅
- 計算式: 10,000,000 ÷ 47 = 212,765.957円

### テストケース2: 建物 + 付属設備

**入力**:
- 建物_取得価額: 10,000,000円（47年、定額法）
- 付属設備_取得価額: 5,000,000円（15年、定額法）

**結果**:
- 建物_年間減価償却費: 212,765.957円 ✅
- 付属設備_年間減価償却費: **333,333.333円** ✅
- **年間減価償却費合計: 546,099.291円** ✅

計算式:
- 建物: 10,000,000 ÷ 47 = 212,765.957円
- 付属設備: 5,000,000 ÷ 15 = 333,333.333円
- 合計: 212,765.957 + 333,333.333 = 546,099.29円

---

## 🔧 技術的な改善点

### 問題1: onchangeイベントが自動的に発火しない

**原因**: ブラウザによっては、プログラムで値を変更してもonchangeイベントが発火しない

**解決策**: oninputイベントを追加
- oninput: 入力中にリアルタイムで発火
- onchange: 入力完了後に発火
- 両方をサポートすることで、確実に自動計算が実行される

### コミット履歴

1. **316fd72**: 減価償却費の自動計算機能を追加
   - モデル定義、ビュー関数、HTMLテンプレートの実装

2. **73ebd9a**: oninputイベントを追加してリアルタイム自動計算を実現
   - oninputとonchangeの両方をサポート

---

## 📝 使用方法

### 1. シミュレーション作成ページにアクセス

https://property-management-app-d46351d49159.herokuapp.com/property/simulations/new

### 2. 減価償却設定セクションで入力

#### 建物部分
- 取得価額を入力（例: 10,000,000円）
- 耐用年数を確認・変更（デフォルト: 47年）
- 償却方法を選択（定額法/定率法）
- 残存価額を入力（通常は0円）

#### 建物付属設備
- 取得価額を入力（例: 5,000,000円）
- 耐用年数を確認・変更（デフォルト: 15年）
- 償却方法を選択（定額法/定率法）
- 残存価額を入力（通常は0円）

#### 構築物
- 取得価額を入力（例: 2,000,000円）
- 耐用年数を確認・変更（デフォルト: 20年）
- 償却方法を選択（定額法/定率法）
- 残存価額を入力（通常は0円）

### 3. 自動計算結果を確認

- 各項目の年間減価償却費が自動的に計算される
- 年間減価償却費合計が青い背景のアラートボックスに表示される

### 4. シミュレーションを作成

- 他の必要項目を入力
- 「シミュレーションを作成」ボタンをクリック

---

## 🎨 UIの特徴

### 視覚的な区別

- **建物部分**: 青色のヘッダー
- **建物付属設備**: 緑色のヘッダー
- **構築物**: 黄色のヘッダー

### ユーザーフレンドリーな設計

- 各項目に説明テキストを表示
- 自動計算結果を読み取り専用フィールドに表示
- 年間減価償却費合計を強調表示
- 千円単位のカンマ区切りで表示

### リアルタイム計算

- 入力値が変更されるたびに自動的に再計算
- oninputとonchangeの両方をサポート

---

## 🔄 自動マイグレーション

新しい12個のフィールドは、**自動マイグレーション機能**により、アプリケーション起動時に自動的にデータベースに追加されます。

手動でのマイグレーションスクリプト実行は不要です。

---

## 📚 参考情報

### 耐用年数の目安

#### 建物（構造別）
- **RC造（鉄筋コンクリート造）**: 47年
- **重量鉄骨造**: 34年
- **軽量鉄骨造**: 27年
- **木造**: 22年

#### 建物付属設備
- **電気設備**: 15年
- **給排水設備**: 15年
- **冷暖房設備**: 15年

#### 構築物
- **アスファルト舗装**: 10年
- **コンクリート舗装**: 15年
- **門・塀**: 20年

---

## 🎉 まとめ

### 実装した機能

1. ✅ 建物、建物付属設備、構築物の3分割方式
2. ✅ 各項目で取得価額、耐用年数、償却方法、残存価額を設定可能
3. ✅ 定額法・定率法の両方に対応
4. ✅ リアルタイム自動計算（oninput + onchange）
5. ✅ 独立シミュレーション・物件ベースシミュレーションの両方に対応
6. ✅ 自動マイグレーション機能による新フィールドの自動追加
7. ✅ 本番環境でのテスト完了

### ユーザーメリット

- **正確な減価償却費の計算**: 3つに分けることでより正確な計算が可能
- **簡単な入力**: 取得価額と耐用年数を入力するだけで自動計算
- **柔軟な設定**: 定額法・定率法を選択可能
- **視覚的にわかりやすい**: 各項目の減価償却費と合計が一目でわかる
- **リアルタイム計算**: 入力中に即座に結果が表示される

### 技術的な成果

- **自動マイグレーション機能の活用**: 新フィールドが自動的に追加される
- **リアルタイム計算の実現**: oninputとonchangeの両方をサポート
- **3分割方式の実装**: 建物、建物付属設備、構築物を個別に管理
- **定額法・定率法の両方に対応**: 柔軟な償却方法の選択

---

**実装者**: Manus AI  
**最終更新**: 2026年1月3日 17:25 JST  
**ステータス**: ✅ 実装完了、本番環境デプロイ済み、テスト完了
