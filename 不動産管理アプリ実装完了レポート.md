# 不動産管理アプリ実装完了レポート

## 実装概要

既存のマルチテナント・マルチストア認証システムに**不動産管理アプリケーション**を統合しました。このアプリケーションは、テナント単位で不動産物件、契約、入居者、家賃収支、減価償却を管理する機能を提供します。

## 実装内容

### 1. データベースモデル（`app/models_property.py`）

以下の6つのテーブルを新規作成しました。

| テーブル名 | 説明 | 主要カラム |
|-----------|------|-----------|
| **T_物件** | 不動産物件情報 | 物件名、物件種別、住所、取得価額、耐用年数、償却方法 |
| **T_部屋** | 物件内の部屋情報 | 部屋番号、間取り、専有面積、賃料、入居状況 |
| **T_入居者** | 入居者情報 | 氏名、フリガナ、生年月日、電話番号、緊急連絡先 |
| **T_契約** | 賃貸契約情報 | 契約開始日、契約終了日、月額賃料、契約状況 |
| **T_家賃収支** | 家賃の収支管理 | 対象年月、請求額、入金額、未収額 |
| **T_減価償却** | 物件の減価償却履歴 | 年度、期首帳簿価額、償却額、期末帳簿価額 |

**特徴**:
- すべてのテーブルに`tenant_id`を持ち、テナント単位でデータを分離
- 論理削除対応（`有効`フラグ）
- タイムスタンプ（`created_at`, `updated_at`）による変更履歴管理

### 2. Blueprint実装（`app/blueprints/property.py`）

不動産管理アプリの全機能を提供するBlueprintを実装しました。

#### 主要機能

**物件管理**
- 物件一覧表示（`/property/properties`）
- 物件登録（`/property/properties/new`）
- 物件詳細表示（`/property/properties/<id>`）
- 物件編集（`/property/properties/<id>/edit`）
- 物件削除（`/property/properties/<id>/delete`）

**部屋管理**
- 部屋登録（`/property/properties/<property_id>/rooms/new`）
- 部屋詳細表示（`/property/rooms/<id>`）
- 部屋編集（`/property/rooms/<id>/edit`）
- 部屋削除（`/property/rooms/<id>/delete`）

**入居者管理**
- 入居者一覧表示（`/property/tenants`）
- 入居者登録（`/property/tenants/new`）
- 入居者詳細表示（`/property/tenants/<id>`）
- 入居者編集（`/property/tenants/<id>/edit`）
- 入居者削除（`/property/tenants/<id>/delete`）

**契約管理**
- 契約一覧表示（`/property/contracts`）
- 契約登録（`/property/contracts/new`）
- 契約詳細表示（`/property/contracts/<id>`）
- 契約編集（`/property/contracts/<id>/edit`）
- 契約終了（`/property/contracts/<id>/terminate`）

**減価償却管理**
- 減価償却一覧表示（`/property/depreciation`）
- 物件別減価償却詳細（`/property/depreciation/<property_id>`）
- 減価償却計算（`/property/depreciation/<property_id>/calculate`）

#### セキュリティ

- **テナント管理者専用**: `@require_tenant_admin`デコレータによりテナント管理者のみがアクセス可能
- **テナントデータ分離**: すべてのクエリで`session.get('tenant_id')`を使用してテナント単位でデータを分離

### 3. テンプレート実装

合計**16個**のテンプレートを作成しました。

| テンプレート名 | 説明 |
|---------------|------|
| `property_dashboard.html` | ダッシュボード（統計情報表示） |
| `property_properties.html` | 物件一覧 |
| `property_property_new.html` | 物件登録フォーム |
| `property_property_detail.html` | 物件詳細 |
| `property_property_edit.html` | 物件編集フォーム |
| `property_room_new.html` | 部屋登録フォーム |
| `property_room_detail.html` | 部屋詳細 |
| `property_room_edit.html` | 部屋編集フォーム |
| `property_tenants.html` | 入居者一覧 |
| `property_tenant_new.html` | 入居者登録フォーム |
| `property_tenant_detail.html` | 入居者詳細 |
| `property_tenant_edit.html` | 入居者編集フォーム |
| `property_contracts.html` | 契約一覧 |
| `property_contract_new.html` | 契約登録フォーム |
| `property_contract_detail.html` | 契約詳細 |
| `property_contract_edit.html` | 契約編集フォーム |
| `property_depreciation.html` | 減価償却一覧 |
| `property_depreciation_detail.html` | 減価償却詳細 |

**デザイン特徴**:
- Bootstrap 5を使用したレスポンシブデザイン
- Font Awesomeアイコンによる視覚的な分かりやすさ
- パンくずリストによるナビゲーション
- カード型レイアウトによる情報の整理

### 4. システム統合

#### AVAILABLE_APPSへの登録（`app/blueprints/tenant_admin.py`）

```python
AVAILABLE_APPS = [
    {
        'name': 'property',
        'display_name': '不動産管理',
        'description': '不動産物件、契約、入居者、家賃収支、減価償却を管理します。',
        'scope': 'tenant',
        'url': 'property.index',
        'icon': 'fas fa-building',
        'color': 'bg-primary'
    }
]
```

**スコープ**: `tenant`（テナント単位のアプリケーション）

#### Blueprintの登録（`app/__init__.py`）

```python
try:
    from .blueprints.property import property_bp
    app.register_blueprint(property_bp)
except Exception as e:
    print(f"⚠️ property blueprint 登録エラー: {e}")
```

#### モデルのインポート（`app/__init__.py`）

```python
from . import models_property  # noqa: F401
```

### 5. マイグレーションスクリプト

`migrate_add_property_tables.py`を作成し、既存のデータベースに不動産管理テーブルを追加できるようにしました。

**実行方法**:
```bash
python migrate_add_property_tables.py
```

## 減価償却機能の詳細

### 対応する償却方法

1. **定額法**: `(取得価額 - 残存価額) / 耐用年数`
2. **定率法**: `期首帳簿価額 × (2.0 / 耐用年数)`

### 計算ロジック

- 前年度の期末帳簿価額を当年度の期首帳簿価額として使用
- 残存価額を下回らないように自動調整
- 年度ごとの償却履歴を保存

### 使用例

1. 物件登録時に取得価額、耐用年数、償却方法を入力
2. 減価償却詳細画面で対象年度を指定して計算実行
3. 償却履歴が自動的に記録される

## ディレクトリ構造

```
property-management-app/
├── app/
│   ├── blueprints/
│   │   └── property.py              # 不動産管理Blueprint
│   ├── models_property.py           # 不動産管理モデル
│   └── templates/
│       ├── property_dashboard.html
│       ├── property_properties.html
│       ├── property_property_new.html
│       ├── property_property_detail.html
│       ├── property_property_edit.html
│       ├── property_room_new.html
│       ├── property_room_detail.html
│       ├── property_room_edit.html
│       ├── property_tenants.html
│       ├── property_tenant_new.html
│       ├── property_tenant_detail.html
│       ├── property_tenant_edit.html
│       ├── property_contracts.html
│       ├── property_contract_new.html
│       ├── property_contract_detail.html
│       ├── property_contract_edit.html
│       ├── property_depreciation.html
│       └── property_depreciation_detail.html
├── migrate_add_property_tables.py   # マイグレーションスクリプト
└── docs/
    └── PROPERTY_APP_DESIGN.md       # 設計ドキュメント
```

## 使用方法

### 1. データベースマイグレーション

```bash
# 仮想環境をアクティベート
source venv/bin/activate

# マイグレーション実行
python migrate_add_property_tables.py
```

### 2. アプリケーション起動

```bash
# 開発サーバー起動
python run.py
```

### 3. アクセス方法

1. テナント管理者としてログイン
2. ダッシュボードから「不動産管理」アプリを選択
3. `/property/`にアクセス

## 今後の拡張可能性

### 追加可能な機能

1. **家賃収支管理の強化**
   - 自動請求書発行
   - 入金管理と督促機能
   - 収支レポート生成

2. **契約管理の強化**
   - 契約更新通知
   - 契約書PDFの自動生成
   - 保証人情報の管理

3. **レポート機能**
   - 空室率レポート
   - 収益分析レポート
   - 減価償却レポート（税務申告用）

4. **通知機能**
   - 契約満了通知
   - 家賃未払い通知
   - メンテナンス予定通知

5. **API連携**
   - 不動産ポータルサイトとの連携
   - 会計ソフトとの連携
   - 電子契約サービスとの連携

## 技術スタック

| 項目 | 技術 |
|------|------|
| フレームワーク | Flask 3.0.0 |
| ORM | SQLAlchemy 2.0.36 |
| データベース | PostgreSQL / SQLite |
| フロントエンド | Bootstrap 5, Font Awesome |
| 認証 | セッションベース認証（既存システム） |

## セキュリティ対策

1. **テナントデータ分離**: すべてのクエリで`tenant_id`による絞り込み
2. **ロール制御**: テナント管理者のみがアクセス可能
3. **論理削除**: データの物理削除を避け、監査証跡を保持
4. **CSRF保護**: Flaskの標準機能を使用（今後強化予定）

## パフォーマンス考慮事項

1. **インデックス**: `tenant_id`, `property_id`, `room_id`などの外部キーにインデックスを設定
2. **遅延ロード**: SQLAlchemyの`lazy='select'`を使用して必要なデータのみを取得
3. **ページネーション**: 今後、大量データ対応のためにページネーションを実装予定

## テスト

現在は手動テストのみ実施。今後、以下のテストを追加予定：

- ユニットテスト（pytest）
- 統合テスト
- E2Eテスト（Selenium）

## まとめ

不動産管理アプリケーションを既存のマルチテナント認証システムに統合し、以下の機能を実装しました。

- ✅ 物件管理（登録・編集・削除・一覧表示）
- ✅ 部屋管理（登録・編集・削除・詳細表示）
- ✅ 入居者管理（登録・編集・削除・一覧表示）
- ✅ 契約管理（登録・編集・終了・一覧表示）
- ✅ 減価償却管理（計算・履歴表示）
- ✅ テナント単位のデータ分離
- ✅ AVAILABLE_APPSへの登録
- ✅ 16個のテンプレート作成
- ✅ マイグレーションスクリプト作成

このアプリケーションは、不動産管理業務の効率化を支援し、テナントごとに独立した管理環境を提供します。

---

**実装日**: 2026年1月3日  
**実装者**: Manus AI Agent  
**バージョン**: 1.0.0
