# 税金計算の修正: 単純累進税率 → 超過累進税率

## 問題点

以前の実装では**単純累進税率**を使用しており、課税所得全体に対して一律の税率を適用していました。これは日本の税制とは異なり、**税金が大幅に過大計算**されていました。

### 修正前の計算方法（誤り）

```python
# 課税所得に応じて税率を決定
税率 = calculate_tax_rate(課税所得)  # 例: 800万円 → 33%

# 全額に同じ税率を適用
税金 = 課税所得 × 税率  # 800万円 × 33% = 264万円 ❌
```

### 問題の具体例

**課税所得800万円の場合:**
- **誤った計算:** 800万円 × 33% = **264万円**
- **正しい計算:** **200.4万円**
- **差額:** 63.6万円の過大計算！

## 修正内容

日本の税制に準拠した**超過累進税率**による正確な税金計算に修正しました。

### 超過累進税率とは

所得を複数の区分に分け、各区分ごとに該当する税率を適用する方式です。

**所得税の税率表:**

| 課税所得 | 税率 | 控除額 |
|---------|------|--------|
| 195万円以下 | 5% | 0円 |
| 195万円超～330万円以下 | 10% | 97,500円 |
| 330万円超～695万円以下 | 20% | 427,500円 |
| 695万円超～900万円以下 | 23% | 636,000円 |
| 900万円超～1,800万円以下 | 33% | 1,536,000円 |
| 1,800万円超～4,000万円以下 | 40% | 2,796,000円 |
| 4,000万円超 | 45% | 4,796,000円 |

**住民税:** 一律10%

### 修正後の計算方法（正しい）

```python
def calculate_progressive_tax(total_income):
    """超過累進税率による税金計算"""
    
    # 所得税の計算（超過累進）
    if total_income <= 1950000:
        income_tax = total_income * 0.05
    elif total_income <= 3300000:
        income_tax = 1950000 * 0.05 + (total_income - 1950000) * 0.10
    elif total_income <= 6950000:
        income_tax = 1950000 * 0.05 + 1350000 * 0.10 + (total_income - 3300000) * 0.20
    # ... (以下同様)
    
    # 住民税の計算（一律10%）
    resident_tax = total_income * 0.10
    
    # 合計税金
    return income_tax + resident_tax
```

## 計算例の比較

### 例1: 課税所得500万円

**修正前（誤り）:**
```
税率 = 30%（330万円超～695万円以下の税率）
税金 = 500万円 × 30% = 150万円 ❌
```

**修正後（正しい）:**
```
所得税:
  195万円 × 5% = 97,500円
  135万円 × 10% = 135,000円
  170万円 × 20% = 340,000円
  小計: 572,500円

住民税:
  500万円 × 10% = 500,000円

合計: 1,072,500円 ✅
実効税率: 21.45%
```

**差額:** 427,500円の過大計算を修正

### 例2: 課税所得800万円

**修正前（誤り）:**
```
税率 = 33%（695万円超～900万円以下の税率）
税金 = 800万円 × 33% = 264万円 ❌
```

**修正後（正しい）:**
```
所得税:
  195万円 × 5% = 97,500円
  135万円 × 10% = 135,000円
  365万円 × 20% = 730,000円
  105万円 × 23% = 241,500円
  小計: 1,204,000円

住民税:
  800万円 × 10% = 800,000円

合計: 2,004,000円 ✅
実効税率: 25.05%
```

**差額:** 636,000円の過大計算を修正

### 例3: 課税所得1000万円

**修正前（誤り）:**
```
税率 = 43%（900万円超～1,800万円以下の税率）
税金 = 1000万円 × 43% = 430万円 ❌
```

**修正後（正しい）:**
```
所得税:
  195万円 × 5% = 97,500円
  135万円 × 10% = 135,000円
  365万円 × 20% = 730,000円
  205万円 × 23% = 471,500円
  100万円 × 33% = 330,000円
  小計: 1,764,000円

住民税:
  1000万円 × 10% = 1,000,000円

合計: 2,764,000円 ✅
実効税率: 27.64%
```

**差額:** 1,536,000円の過大計算を修正

## 実装の詳細

### 1. 新関数: calculate_progressive_tax()

超過累進税率による正確な税金計算を実装しました。

**特徴:**
- 所得を区分ごとに分けて計算
- 各区分に該当する税率を適用
- 所得税と住民税を合算

### 2. 既存関数の変更: calculate_tax_rate()

互換性のため関数名は残しつつ、実効税率を計算するように変更しました。

```python
def calculate_tax_rate(total_income):
    """表示用の実効税率を計算"""
    if total_income <= 0:
        return Decimal('0')
    
    total_tax = calculate_progressive_tax(total_income)
    effective_rate = (total_tax / total_income) * Decimal('100')
    
    return effective_rate
```

### 3. シミュレーション計算の修正

```python
# 税金計算（超過累進税率）
if simulation.税率:
    # 手動設定された税率を使用
    税金 = (不動産所得 + simulation.その他所得) * (simulation.税率 / 100)
else:
    # 超過累進税率で税金を計算
    課税所得 = 不動産所得 + simulation.その他所得
    税金 = calculate_progressive_tax(課税所得)
```

**ポイント:**
- 手動設定された税率がある場合はそれを優先
- 自動計算の場合は超過累進税率を使用

## 影響範囲

### 既存のシミュレーション

既存のシミュレーションを再計算すると、税金が減少し、キャッシュフローが改善されます。

**変更が必要な操作:**
- シミュレーションの編集機能で「更新」ボタンをクリック
- または、新規シミュレーションを作成

### 手動税率設定

手動で税率を設定したシミュレーションには影響しません。引き続き設定された税率が使用されます。

## テスト結果

```
超過累進税率による税金計算テスト
============================================================
課税所得: 500万円 (5,000,000円)
税金: 1,072,500円
実効税率: 21.45%

課税所得: 800万円 (8,000,000円)
税金: 2,004,000円
実効税率: 25.05%

課税所得: 1000万円 (10,000,000円)
税金: 2,764,000円
実効税率: 27.64%
```

すべてのテストケースで正確な税金計算が確認されました。

## デプロイ状況

✅ すべての変更をGitHubにプッシュ済み
✅ Herokuで自動デプロイ完了
✅ 本番環境で利用可能

## まとめ

税金計算を日本の税制に準拠した超過累進税率に修正しました。これにより、不動産投資シミュレーションの精度が大幅に向上し、より現実的なキャッシュフロー予測が可能になりました。

**主な改善点:**
- ✅ 税金の過大計算を修正
- ✅ 日本の税制に準拠した正確な計算
- ✅ より現実的なキャッシュフロー予測
- ✅ 実効税率の表示に対応

ご指摘いただき、ありがとうございました。
